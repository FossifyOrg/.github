name: Update baselines

on:
  workflow_call:

concurrency:
  group: update-baseline-${{ github.repository }}
  cancel-in-progress: true

jobs:
  update-baselines:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Checkout .github repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          repository: FossifyOrg/.github
          path: .github-repo

      - uses: FossifyOrg/.github/.github/actions/gradle-cache@main

      - name: Set up JDK
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Update baselines
        run: ./gradlew updateLintBaseline detektBaseline

      - name: Check for diff
        id: git-diff
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Get app token
        if: ${{ steps.git-diff.outputs.changed == 'true' }}
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Create or update baseline refresh PR
        if: ${{ steps.git-diff.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725
        with:
          token: ${{ steps.app-token.outputs.token }}
          sign-commits: true
          branch: fossifybot/update-lint-baselines
          title: "chore: update lint baselines"
          commit-message: "chore: update lint baselines"
          body: ""
          add-paths: |
            **/lint-baseline.xml
            **/detekt-baseline.xml

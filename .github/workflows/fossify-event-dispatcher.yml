name: Fossify event dispatcher

on:
  workflow_dispatch:
    inputs:
      task:
        description: "What to run"
        required: true
        default: "prepare-release"
        type: choice
        options:
          - "prepare-release"
          - "update-lint-baselines"
          - "update-commons"
      repository:
        description: "Trigger a specific repo or all"
        required: true
        default: "all"
        type: choice
        options:
          - "all"
          - "FossifyOrg/Calculator"
          - "FossifyOrg/Calendar"
          - "FossifyOrg/Camera"
          - "FossifyOrg/Clock"
          - "FossifyOrg/Contacts"
          - "FossifyOrg/File-Manager"
          - "FossifyOrg/Gallery"
          - "FossifyOrg/Keyboard"
          - "FossifyOrg/Launcher"
          - "FossifyOrg/Messages"
          - "FossifyOrg/Music-Player"
          - "FossifyOrg/Notes"
          - "FossifyOrg/Paint"
          - "FossifyOrg/Phone"
          - "FossifyOrg/Thank-You"
          - "FossifyOrg/Voice-Recorder"

  workflow_call:
    inputs:
      task:
        required: true
        type: string
      repository:
        required: true
        type: string

concurrency:
  group: "manual-dispatcher-${{ inputs.task || github.event.inputs.task }}-${{ inputs.repository || github.event.inputs.repository }}"
  cancel-in-progress: true

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e
        with:
          egress-policy: audit

      - id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const repos = [
              'FossifyOrg/Calculator',
              'FossifyOrg/Calendar',
              'FossifyOrg/Camera',
              'FossifyOrg/Clock',
              'FossifyOrg/Contacts',
              'FossifyOrg/File-Manager',
              'FossifyOrg/Gallery',
              'FossifyOrg/Keyboard',
              'FossifyOrg/Launcher',
              'FossifyOrg/Messages',
              'FossifyOrg/Music-Player',
              'FossifyOrg/Notes',
              'FossifyOrg/Paint',
              'FossifyOrg/Phone',
              'FossifyOrg/Thank-You',
              'FossifyOrg/Voice-Recorder',
            ];

            const selectedRepo = '${{ inputs.repository || github.event.inputs.repository }}';
            const task = '${{ inputs.task || github.event.inputs.task }}';

            let reposToProcess = [];
            if (selectedRepo === 'all') {
              reposToProcess = repos;
              console.log(`Manual ${task} for all repositories (${repos.length} repos):`, reposToProcess);
            } else {
              reposToProcess = [selectedRepo];
              console.log(`Manual ${task} for: ${selectedRepo}`);
            }

            for (const repoPath of reposToProcess) {
              console.log(`Dispatching "${task}" to ${repoPath}`);
              const [owner, repo] = repoPath.split('/');

              try {
                await github.rest.repos.createDispatchEvent({
                  owner,
                  repo,
                  event_type: task,
                });
              } catch (e) {
                console.warn(`${repoPath} failed: ${e.message}`);
              }

              await new Promise(r => setTimeout(r, 1000));
            }

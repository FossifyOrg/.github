name: Merge release PRs

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Merge PR in a specific repo or all"
        required: true
        default: "all"
        type: choice
        options:
          - "all"
          - "FossifyOrg/Calculator"
          - "FossifyOrg/Calendar"
          - "FossifyOrg/Camera"
          - "FossifyOrg/Clock"
          - "FossifyOrg/Contacts"
          - "FossifyOrg/File-Manager"
          - "FossifyOrg/Gallery"
          - "FossifyOrg/Keyboard"
          - "FossifyOrg/Launcher"
          - "FossifyOrg/Messages"
          - "FossifyOrg/Music-Player"
          - "FossifyOrg/Notes"
          - "FossifyOrg/Paint"
          - "FossifyOrg/Phone"
          - "FossifyOrg/Thank-You"
          - "FossifyOrg/Voice-Recorder"

concurrency:
  group: "merge-release-prs"
  cancel-in-progress: true

jobs:
  merge:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2
        with:
          egress-policy: audit

      - name: Merge release PRs
        run: |
          set -uo pipefail
          REPOS=(
            "FossifyOrg/Calculator"
            "FossifyOrg/Calendar"
            "FossifyOrg/Camera"
            "FossifyOrg/Clock"
            "FossifyOrg/Contacts"
            "FossifyOrg/File-Manager"
            "FossifyOrg/Gallery"
            "FossifyOrg/Keyboard"
            "FossifyOrg/Launcher"
            "FossifyOrg/Messages"
            "FossifyOrg/Music-Player"
            "FossifyOrg/Notes"
            "FossifyOrg/Paint"
            "FossifyOrg/Phone"
            "FossifyOrg/Thank-You"
            "FossifyOrg/Voice-Recorder"
          )

          SELECTED_REPO="${{ github.event.inputs.repository }}"
          BRANCH="fossifybot/release"

          if [[ "$SELECTED_REPO" != "all" ]]; then
            REPOS=("$SELECTED_REPO")
            echo "Processing single repository: $SELECTED_REPO"
          else
            echo "Processing all repositories (${#REPOS[@]} repos)"
          fi

          for repo in "${REPOS[@]}"; do
            echo "Processing: $repo"
            
            PR_NUMBER=$(gh pr list --repo "$repo" --head "$BRANCH" --search "author:fossifybot[bot]" --json number --jq '.[0].number // empty' 2>/dev/null)
            if [[ -z "$PR_NUMBER" ]]; then
              echo "[$repo]: No open PR found for branch $BRANCH. Skipping."
              continue
            fi

            echo "[$repo]: Found PR #$PR_NUMBER for branch $BRANCH"

            if gh pr review --repo "$repo" --approve "$PR_NUMBER" 2>/dev/null; then
              echo "[$repo]: PR #$PR_NUMBER approved"
            else
              echo "[$repo]: Failed to approve PR #$PR_NUMBER"
            fi

            if gh pr merge --repo "$repo" --squash --auto "$PR_NUMBER" 2>/dev/null; then
              echo "[$repo]: PR #$PR_NUMBER merged successfully"
            else
              echo "[$repo]: Failed to merge PR #$PR_NUMBER. Skipping."
            fi

            sleep 1
          done

          echo "Done processing all repositories."
